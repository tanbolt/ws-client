!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Ws=e()}(this,function(){"use strict";function n(t){this.socket=t}function s(){var e=this,t=s.client(e.url);e._useBlob&&(t.binaryType="blob"),t.onOpen(function(){e._open(),t.send({data:"9"+JSON.stringify([e._customHeaders])})}),t.onMessage(function(t){e._transport.receiveData(t.data)}),t.onError(function(t){e._error(t.errMsg?t.errMsg:"WeSocket error")}),t.onClose(function(t){e._close(t.code,t.reason)}),e.socket=new n(t)}function c(t){return!isNaN(t-parseFloat(t))}function r(t){return t&&"[object Function]"==={}.toString.call(t)}function a(t){return"[object Object]"===Object.prototype.toString.call(t)}function l(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)}function u(t){return null!==t&&"object"==typeof t&&"undefined"!=typeof ArrayBuffer&&t.constructor===ArrayBuffer}function i(t,e){var n=this;if(e||"string"!=typeof t)h.call(n,t,!0);else if("1"!==(t+=""))if("2"!==t){var s=t.indexOf("[");if(-1!==s){var i=t.substr(0,s);t=function(t){try{return JSON.parse(t)}catch(t){return!1}}(t.substr(s)),"0"!==i?t&&l(t)&&t.length&&(-1===i.indexOf("-")?f.call(n,i,t):(i=i.split("-"),h.call(n,[parseInt(i[1]),i[0],t]))):function(t){var e=l(t)&&0<t.length&&c(t[0])?Math.round(t[0]):3e4;this._inited=!0,function(){var e=this;e._aheadMessage.forEach(function(t){_.call(e,t[0],t[1],t[2])})}.call(this),function(){var e=this;e._presendMessage.forEach(function(t){p.call(e,t[0],t[1])})}.call(this),this._ws.polling||function(t){var e=this;e._interval=setInterval(function(){d.call(e,"1",null)},t)}.call(this,e)}.call(n,t)}}else o.call(n)}function o(){this._interval&&(clearInterval(this._interval),this._interval=null)}function h(t,e){var n=this;e?n._dataMessage.length&&(n._bufferMessage.push(t),n._bufferMessage.length===n._dataMessage[0][0]&&(function(t,e){t[2]=function n(t,s){{if(l(t)){var i=[];return t.forEach(function(t,e){i[e]=n(t,s)}),i}if(a(t)){if("_bin_"in t&&"_num_"in t&&c(t._num_))return s[t._num_];for(var e in t)t.hasOwnProperty(e)&&(t[e]=n(t[e],s));return t}return t}}(t[2],e),f.call(this,t[1],t[2])}.call(this,n._dataMessage.shift(),n._bufferMessage.slice()),n._bufferMessage=[])):n._dataMessage.push(t)}function f(t,e){var n=t.charAt(0);if("3"===n){var s=e.shift();this.has(s)&&function(t,e,n){this._inited?_.call(this,t,e,n):this._aheadMessage.push([t,e,n])}.call(this,t,s,e)}else"4"===n&&function(t,e){if(t.length<2)return;var n=t.substr(1);if(!("s"+n in this._callbacks))return;this._callbacks["s"+n].apply(this._ws,e)}.call(this,t,e)}function _(t,e,n){var s=this;if(1<t.length){var i=t.substr(1);s._replies["r"+i]=1,n.push(function(){var t=[].slice.call(arguments);t.push(i),function(t){var e=t.pop();if(!("r"+e in this._replies))return;delete this._replies["r"+e],p.call(this,t,e)}.call(s,t)})}s.get(e).forEach(function(t){t.callback.apply(s._ws,n)})}function p(t,e){if(this._inited){var n;if(!1===e){n="3";var s=t.pop();r(s)?n+=""+function(t){var e=null;for(var n in this._callbacks)e=n;e=null===e?0:parseInt(e.substr(1))+1;return this._callbacks["s"+e]=t,e}.call(this,s):t.push(s)}else n="4"+e;var i=[];t=function n(t,s){{if(l(t)){var i=[];return t.forEach(function(t,e){i[e]=n(t,s)}),i}if(null!==(o=t)&&"object"==typeof o&&"undefined"!=typeof Blob&&o.constructor===Blob)return b(t,"blob",s);if(u(t))return b(t,"arrayBuffer",s);if(null!==(r=t)&&"object"==typeof r&&"buffer"in r&&u(r.buffer))return b(t,"typeArray",s);if(a(t)){if("_bin_"in t&&"_num_"in t&&c(t._num_))return s[t._num_];for(var e in t)t.hasOwnProperty(e)&&(t[e]=n(t[e],s));return t}return t}var r;var o}(t,i),d.call(this,n,t,i)}else this._presendMessage.push([t,e])}function d(t,e,n){if(this._inited){var s=this._ws;if(s.polling)s.socket.send(t,e,n);else if(null===e)s.socket.send(t);else{var i=n.length;s.socket.send(t+""+(i?"-"+i:"")+JSON.stringify(e)),i&&n.forEach(function(t){s.socket.send(t.data)})}}}function b(t,e,n){return n.push({type:e,data:t}),{_bin_:1,_num_:n.length-1}}function v(t){var e="",n=t.lastIndexOf(".");return-1<n&&(e=t.slice(0,n),t=t.substr(n+1)),[e,t]}function y(t){this._ws=t,this._inited=!1,this._interval=null,this._listeners={},this._replies={},this._callbacks={},this._dataMessage=[],this._bufferMessage=[],this._presendMessage=[],this._aheadMessage=[]}function t(t){var e=s.client();this.url=t,this.socket=null,this.polling=e<1,this.wechat=1<e,this._useBlob=!1,this._attempt=0,this._reconnectTimes=-1,this._reconnectDelayMin=1e3,this._reconnectDelayRand=2e3,this._customHeaders={},this._openfn=null,this._errorfn=null,this._closefn=null,this._resolveBase64=null,this._transport=new y(this)}function g(t){if(!c(t))throw new Error("arguments must be number");return Math.floor(t)}function m(t){if(!r(t))throw new Error("callback must be function");return t}return n.prototype.send=function(t){this.socket.send({data:t})},n.prototype.close=function(t,e){arguments.length?this.socket.close({code:t,reason:e||""}):this.socket.close()},s.client=function(t){var e=void 0===t,n="object"==typeof wx&&"connectSocket"in wx;if(!n){if(e)return 0;throw"Client not support webSocket"}if(e)return 2;if(n=wx.connectSocket({url:t}),!n)throw"Create wechat webSocket failed";return n},y.prototype={on:function(t,e){var n=(t=v(t))[0];return(t=t[1])in this._listeners||(this._listeners[t]=[]),this._listeners[t].push({prefix:n,callback:e}),this},off:function(t){var e=(t=v(t))[0];if(!((t=t[1])in this._listeners))return this;if(""===e)return delete this._listeners[t],this;for(var n=this._listeners[t],s=n.length;s--;)n[s].prefix===e&&n.splice(s,1);return this},has:function(t){return t in this._listeners},get:function(t){return this.has(t)?this._listeners[t]:[]},receiveData:function(t,e){i.call(this,t,e)},sendData:function(t){p.call(this,t,!1)},reset:function(){this._inited=!1,this._replies={},this._callbacks={},this._dataMessage=[],this._bufferMessage=[],this._presendMessage=[],this._aheadMessage=[],o.call(this)}},t.prototype={_open:function(){this._openfn&&this._openfn.call(this,this._attempt),this._attempt=0},_error:function(t){this._errorfn&&this._errorfn(this._attempt,t),0===this._reconnectTimes||0<this._reconnectTimes&&this._attempt>=this._reconnectTimes||setTimeout(this.open.bind(this),this._reconnectDelayMin+parseInt(Math.random()*(this._reconnectDelayRand+1),10))},_close:function(t,e){this._transport.reset(),this._closefn&&this._closefn(t,e)},reconnectTimes:function(t){return this._reconnectTimes=g(t),this},reconnectDelay:function(t,e){return this._reconnectDelayMin=g(t),this._reconnectDelayRand=Math.max(g(e)-this._reconnectDelayMin,800),this},useBlob:function(t){return this._useBlob=!!t,this.socket&&(this.socket.binaryType=t?"blob":"arraybuffer"),this},resolveBase64:function(t){return this._resolveBase64=m(t),this},headers:function(t){return a(t)&&(this._customHeaders=t),this},onOpen:function(t){return this._openfn=m(t),this},onError:function(t){return this._errorfn=m(t),this},onClose:function(t){return this._closefn=m(t),this},on:function(t,e){return this._transport.on(t,m(e)),this},off:function(){var e=this;return function n(t){return t.reduce(function(t,e){return t.concat(l(e)?n(e):e)},[])}([].slice.call(arguments)).forEach(function(t){e._transport.off(t)}),e},open:function(){return this._attempt++,function(){try{if(this.polling){if("undefined"==typeof ___openRequest||!r(___openRequest))throw"Client not support WebSocket";___openRequest.call(this)}else s.call(this)}catch(t){if(!this._errorfn)throw new Error(t);this._errorfn(t)}}.call(this),this},emit:function(t,e){return this._transport.sendData([].slice.call(arguments)),this},close:function(t,e){return((t=!!c(t)&&parseInt(t))<3e3&&1e3!==t||4999<t)&&(t=!1),t?this.socket.close(t,e?e+"":""):this.socket.close(),this}},t});