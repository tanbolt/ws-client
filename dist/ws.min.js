!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Ws=t()}(this,function(){"use strict";var c,d,e,f,g;this&&!this.JSON&&(this.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:(c=Object.prototype.toString,d=Array.isArray||function(e){return"[object Array]"===c.call(e)},e={'"':'\\"',"\\":"\\\\","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t"},f=function(t){return e[t]||"\\u"+(t.charCodeAt(0)+65536).toString(16).substr(1)},g=/[\\"\u0000-\u001F\u2028\u2029]/g,function e(t){if(null==t)return"null";if("number"==typeof t)return isFinite(t)?t.toString():"null";if("boolean"==typeof t)return t.toString();if("object"==typeof t){if("function"==typeof t.toJSON)return e(t.toJSON());if(d(t)){for(var n="[",r=0;r<t.length;r++)n+=(r?", ":"")+e(t[r]);return n+"]"}if("[object Object]"===c.call(t)){var i=[];for(var o in t)t.hasOwnProperty(o)&&i.push(e(o)+": "+e(t[o]));return"{"+i.join(", ")+"}"}}return'"'+t.toString().replace(g,f)+'"'})}),Array.prototype.reduce||(Array.prototype.reduce=function(e,t){var n,r,i,o,s,a=Object(this),c=a.length>>>0;if("function"!=typeof e)throw new TypeError;if(0===c&&void 0===t)throw new TypeError;if(void(n=0)!==t)r=t;else{for(i=!1;!i&&n<c;)o=n.toString(),(i=a.hasOwnProperty(o))&&(r=a[o]),n+=1;if(!i)throw new TypeError}for(;n<c;)o=n.toString(),(i=a.hasOwnProperty(o))&&(s=a[o],r=e.call(void 0,r,s,n,a)),n+=1;return r}),Array.prototype.forEach||(Array.prototype.forEach=function(e){var t,n;if(null==this)throw new TypeError("this is null or not defined");var r=Object(this),i=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(1<arguments.length&&(t=arguments[1]),n=0;n<i;){var o;n in r&&(o=r[n],e.call(t,o,n,r)),n++}});var global="undefined"!=typeof window?window:this,setTimeout=global.setTimeout,clearTimeout=global.clearTimeout,XMLHttpRequest=global.XMLHttpRequest,XDomainRequest=global.XDomainRequest,NativeEventSource=global.EventSource,document=global.document,bestTransport=null;function throwError(e){setTimeout(function(){throw e},0)}function getBestTransport(){return null===bestTransport&&(bestTransport=XMLHttpRequest&&"withCredentials"in XMLHttpRequest.prototype?XMLHttpRequest:XDomainRequest),bestTransport}null==Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t});var k=function(){};function XHRWrapper(e){this.withCredentials=!1,this.responseType="",this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=k,this.onreadystatechange=k,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=k}function XHRTransport(e){this._xhr=new XHRWrapper(e)}function EventTarget(){this._listeners=Object.create(null)}function Event(e){this.type=e,this.target=void 0}function MessageEvent(e,t){Event.call(this,e),this.data=t.data,this.lastEventId=t.lastEventId}XHRWrapper.prototype.open=function(e,t){this._abort(!0);var i=this,o=this._xhr,s=1,n=0;this._abort=function(e){0!==i._sendTimeout&&(clearTimeout(i._sendTimeout),i._sendTimeout=0),1!==s&&2!==s&&3!==s||(s=4,o.onload=k,o.onerror=k,o.onabort=k,o.onprogress=k,o.onreadystatechange=k,o.abort(),0!==n&&(clearTimeout(n),n=0),e||(i.readyState=4,i.onreadystatechange())),s=0};var r=function(){if(1===s){var t=0,n="",r=void 0;if("contentType"in o)t=200,n="OK",r=o.contentType;else try{t=o.status,n=o.statusText,r=o.getResponseHeader("Content-Type")}catch(e){n="",r=void(t=0)}0!==t&&(s=2,i.readyState=2,i.status=t,i.statusText=n,i._contentType=r,i.onreadystatechange())}},a=function(){if(r(),2===s||3===s){s=3;var e="";try{e=o.responseText}catch(e){}i.readyState=3,i.responseText=e,i.onprogress()}},c=function(){a(),1!==s&&2!==s&&3!==s||(s=4,0!==n&&(clearTimeout(n),n=0),i.readyState=4,i.onreadystatechange())},u=function(){n=setTimeout(function(){u()},500),3===o.readyState&&a()};o.onload=c,o.onerror=c,o.onabort=c,"sendAsBinary"in XMLHttpRequest.prototype||"mozAnon"in XMLHttpRequest.prototype||(o.onprogress=a),o.onreadystatechange=function(){null!=o&&(4===o.readyState?c():3===o.readyState?a():2===o.readyState&&r())},"contentType"in o&&(t+=(-1===t.indexOf("?",0)?"?":"&")+"padding=true"),o.open(e,t,!0),"readyState"in o&&(n=setTimeout(function(){u()},0))},XHRWrapper.prototype.abort=function(){this._abort(!1)},XHRWrapper.prototype.getResponseHeader=function(e){return this._contentType},XHRWrapper.prototype.setRequestHeader=function(e,t){var n=this._xhr;"setRequestHeader"in n&&n.setRequestHeader(e,t)},XHRWrapper.prototype.send=function(e){if("ontimeout"in XMLHttpRequest.prototype||null==document||null==document.readyState||"complete"===document.readyState){var t=this._xhr;t.withCredentials=this.withCredentials,t.responseType=this.responseType;try{t.send(e)}catch(e){throw e}}else{var n=this;n._sendTimeout=setTimeout(function(){n._sendTimeout=0,n.send(e)},4)}},XHRTransport.prototype.open=function(r,t,i,e,n,o){var s=this._xhr;s.open("GET",e);var a=0;for(var c in s.onprogress=function(){var e=s.responseText.slice(a);a+=e.length,t(e)},s.onreadystatechange=function(){if(2===s.readyState){var e=s.status,t=s.statusText,n=s.getResponseHeader("Content-Type");r(e,t,n)}else 4===s.readyState&&i()},s.withCredentials=n,s.responseType="text",o)Object.prototype.hasOwnProperty.call(o,c)&&s.setRequestHeader(c,o[c]);s.send()},XHRTransport.prototype.cancel=function(){this._xhr.abort()},EventTarget.prototype.dispatchEvent=function(e){var t=(e.target=this)._listeners[e.type];if(null!=t)for(var n=t.length,r=0;r<n;r+=1){var i=t[r];try{"function"==typeof i.handleEvent?i.handleEvent(e):i.call(this,e)}catch(e){throwError(e)}}},EventTarget.prototype.addEventListener=function(e,t){e=String(e);var n=this._listeners,r=n[e];null==r&&(r=[],n[e]=r);for(var i=!1,o=0;o<r.length;o+=1)r[o]===t&&(i=!0);i||r.push(t)},EventTarget.prototype.removeEventListener=function(e,t){e=String(e);var n=this._listeners,r=n[e];if(null!=r){for(var i=[],o=0;o<r.length;o+=1)r[o]!==t&&i.push(r[o]);0===i.length?delete n[e]:n[e]=i}},MessageEvent.prototype=Object.create(Event.prototype);var WAITING=-1,CONNECTING=0,OPEN=1,CLOSED=2,AFTER_CR=-1,FIELD_START=0,FIELD=1,VALUE_START=2,VALUE=3,contentTypeRegExp=/^text\/event\-stream;?(\s*charset\=utf\-8)?$/i,MINIMUM_DURATION=1e3,MAXIMUM_DURATION=18e6,parseDuration=function(e,t){var n=parseInt(e,10);return n!=n&&(n=t),clampDuration(n)},clampDuration=function(e){return Math.min(Math.max(e,MINIMUM_DURATION),MAXIMUM_DURATION)},fire=function(e,t,n){try{"function"==typeof t&&t.call(e,n)}catch(e){throwError(e)}};function EventSourcePolyfill(e,t){EventTarget.call(this),this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this._close=void 0,start(this,e,t)}function start(u,r,e){r=String(r);var i=null!=e&&Boolean(e.withCredentials),l=clampDuration(1e3),f=null!=e&&null!=e.heartbeatTimeout?parseDuration(e.heartbeatTimeout,45e3):clampDuration(45e3),h="",p=l,d=!1,o=null!=e&&null!=e.headers?JSON.parse(JSON.stringify(e.headers)):void 0,s=new XHRTransport(new(null!=e&&null!=e.Transport?e.Transport:getBestTransport())),_=0,y=WAITING,v="",g="",b="",E="",T=FIELD_START,m=0,w=0,a=function(e,t,n){if(y===CONNECTING)if(200===e&&null!=n&&contentTypeRegExp.test(n)){y=OPEN,d=!0,p=l,u.readyState=OPEN;var r=new Event("open");u.dispatchEvent(r),fire(u,u.onopen,r)}else{var i="";200!==e?(t&&(t=t.replace(/\s+/g," ")),i="EventSource's response has a status "+e+" "+t+" that is not 200. Aborting the connection."):i="EventSource's response has a Content-Type specifying an unsupported type: "+(null==n?"-":n.replace(/\s+/g," "))+". Aborting the connection.",throwError(new Error(i)),A();r=new Event("error");u.dispatchEvent(r),fire(u,u.onerror,r)}},c=function(e){if(y===OPEN){for(var t=-1,n=0;n<e.length;n+=1){(o=e.charCodeAt(n))!=="\n".charCodeAt(0)&&o!=="\r".charCodeAt(0)||(t=n)}var r=(-1!==t?E:"")+e.slice(0,t+1);E=(-1===t?E:"")+e.slice(t+1),""!==r&&(d=!0);for(var i=0;i<r.length;i+=1){var o=r.charCodeAt(i);if(T===AFTER_CR&&o==="\n".charCodeAt(0))T=FIELD_START;else if(T===AFTER_CR&&(T=FIELD_START),o==="\r".charCodeAt(0)||o==="\n".charCodeAt(0)){if(T!==FIELD_START){T===FIELD&&(w=i+1);var s=r.slice(m,w-1),a=r.slice(w+(w<i&&r.charCodeAt(w)===" ".charCodeAt(0)?1:0),i);"data"===s?(v+="\n",v+=a):"id"===s?g=a:"event"===s?b=a:"retry"===s?(l=parseDuration(a,l),p=l):"heartbeatTimeout"===s&&(f=parseDuration(a,f),0!==_&&(clearTimeout(_),_=setTimeout(function(){O()},f)))}if(T===FIELD_START){if(""!==v){h=g,""===b&&(b="message");var c=new MessageEvent(b,{data:v.slice(1),lastEventId:g});if(u.dispatchEvent(c),"message"===b&&fire(u,u.onmessage,c),y===CLOSED)return}b=v=""}T=o==="\r".charCodeAt(0)?AFTER_CR:FIELD_START}else T===FIELD_START&&(m=i,T=FIELD),T===FIELD?o===":".charCodeAt(0)&&(w=i+1,T=VALUE_START):T===VALUE_START&&(T=VALUE)}}},S=function(){if(y===OPEN||y===CONNECTING){y=WAITING,0!==_&&(clearTimeout(_),_=0),_=setTimeout(function(){O()},p),p=clampDuration(Math.min(16*l,2*p)),u.readyState=CONNECTING;var e=new Event("error");u.dispatchEvent(e),fire(u,u.onerror,e)}},A=function(){y=CLOSED,s.cancel(),0!==_&&(clearTimeout(_),_=0),u.readyState=CLOSED},O=function(){if(_=0,y===WAITING){d=!1,_=setTimeout(function(){O()},f),y=CONNECTING,g=h,E=b=v="",w=m=0,T=FIELD_START;var e=r;"data:"!==r.slice(0,5)&&"blob:"!==r.slice(0,5)&&(e=r+(-1===r.indexOf("?",0)?"?":"&")+"lastEventId="+encodeURIComponent(h));var t={Accept:"text/event-stream"};if(null!=o)for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t[n]=o[n]);try{s.open(a,c,S,e,i,t)}catch(e){throw A(),e}}else d?(d=!1,_=setTimeout(function(){O()},f)):(throwError(new Error("No activity within "+f+" milliseconds. Reconnecting.")),s.cancel())};u.url=r,u.readyState=CONNECTING,u.withCredentials=i,u._close=A,O()}EventSourcePolyfill.prototype=Object.create(EventTarget.prototype),EventSourcePolyfill.prototype.CONNECTING=CONNECTING,EventSourcePolyfill.prototype.OPEN=OPEN,EventSourcePolyfill.prototype.CLOSED=CLOSED,EventSourcePolyfill.prototype.close=function(){this._close()},EventSourcePolyfill.CONNECTING=CONNECTING,EventSourcePolyfill.OPEN=OPEN,EventSourcePolyfill.CLOSED=CLOSED,EventSourcePolyfill.prototype.withCredentials=void 0,global.EventSourcePolyfill=EventSourcePolyfill,global.NativeEventSource=NativeEventSource,null==XMLHttpRequest||null!=NativeEventSource&&"withCredentials"in NativeEventSource.prototype||(global.EventSource=EventSourcePolyfill);for(var _base64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",_base64_lookup=new Uint8Array(256),i=0;i<_base64_chars.length;i++)_base64_lookup[_base64_chars.charCodeAt(i)]=i;function decodeBase64(e){var t,n,r,i,o,s=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);var u=new ArrayBuffer(s),l=new Uint8Array(u);for(t=0;t<a;t+=4)n=_base64_lookup[e.charCodeAt(t)],r=_base64_lookup[e.charCodeAt(t+1)],i=_base64_lookup[e.charCodeAt(t+2)],o=_base64_lookup[e.charCodeAt(t+3)],l[c++]=n<<2|r>>4,l[c++]=(15&r)<<4|i>>2,l[c++]=(3&i)<<6|63&o;return u}var _encoderInstance=null;function str2utf8(e){if(null===_encoderInstance&&(_encoderInstance="undefined"!=typeof TextEncoder&&new TextEncoder),_encoderInstance)return _encoderInstance.encode(e);for(var t=e.length,n=-1,r=new Uint8Array(3*t),i=0,o=0,s=0;s!==t;){if(i=e.charCodeAt(s),s+=1,55296<=i&&i<=56319){if(s===t){r[n+=1]=239,r[n+=1]=191,r[n+=1]=189;break}if(!(56320<=(o=e.charCodeAt(s))&&o<=57343)){r[n+=1]=239,r[n+=1]=191,r[n+=1]=189;continue}if(s+=1,65535<(i=1024*(i-55296)+o-56320+65536)){r[n+=1]=240|i>>>18,r[n+=1]=128|i>>>12&63,r[n+=1]=128|i>>>6&63,r[n+=1]=128|63&i;continue}}i<=127?r[n+=1]=0|i:(i<=2047?r[n+=1]=192|i>>>6:(r[n+=1]=224|i>>>12,r[n+=1]=128|i>>>6&63),r[n+=1]=128|63&i)}return new Uint8Array(r.buffer.slice(0,n+1))}function create(e){return document.createElement(e)}function Request(e){var t=this,n=getBestTransport(),r=e.url.split("://");r[0]=r[0].toLowerCase(),r="http"+("wss"===r[0]?"s":"")+"://"+r[1],t._ws=e,t._id=null,t._url=r,t._alive=r+(-1===r.indexOf("?",0)?"?":"&")+"polling=polling",t._xhr=new XHRWrapper(new n),t._header=null,t._connected=!1}Request.prototype.connect=function(){var n=this;n._id=null;var r=new EventSource(n._alive,{heartbeatTimeout:9e4});r.addEventListener("open",function(e){n._connected=!0,n._ws._open()}),r.addEventListener("error",function(e){r.close(),n._ws._error("Connect eventSource failed"),n.disconnect(1006,"")}),r.addEventListener("failed",function(e){r.close(),n.disconnect(1013,"Try Again Later")}),r.addEventListener("success",function(e){n._id=e.data,n._url+=(-1===n._url.indexOf("?",0)?"?":"&")+"id="+n._id,n.auth(n._ws._customHeaders)}),r.addEventListener("message",function(e){n._connected&&n._ws._transport.receiveData(e.data)}),r.addEventListener("binary",function(e){n._connected&&n._ws._transport.receiveData(n._ws._resolveBase64?n._ws._resolveBase64(e.data):decodeBase64(e.data),!0)}),r.addEventListener("offline",function(e){if(r.close(),n._connected){var t;try{t=JSON.parse(e.data)}catch(e){t={}}"code"in t?n.disconnect(t.code,"reason"in t?t.reason:""):n.disconnect(1006,"")}})},Request.prototype.auth=function(e){if(this._id&&this._connected)if("object"==typeof document&&"createElement"in document){var t=create("div");t.style.display="none";var n,r="_auth"+Date.now();try{n=create('<iframe name="'+r+'" id="'+r+'">')}catch(e){(n=create("iframe")).name=r,n.id=r}n.onload=function(){document.body.removeChild(t)},n.onerror=function(){document.body.removeChild(t)},t.appendChild(n);var i,o,s=create("form");for(o in s.method="POST",s.action=this._url,s.target=r,e._action="open",e)e.hasOwnProperty(o)&&((i=create("input")).name=o,i.value=e[o]),s.appendChild(i);t.appendChild(s),document.body.appendChild(t),s.submit()}else this.post("open"+JSON.stringify(e),!0)},Request.prototype.post=function(e,t){if(this._id&&this._connected){var n=this._xhr;n.withCredentials=Boolean(t),n.open("POST",this._url,!0),n.responseType="text",n.send(e)}return this},Request.prototype.send=function(e,t,n){if(!t||!this._id||!this._connected)return this;if(t=e+""+JSON.stringify(t),isArray(n)&&n.length){n.unshift({type:"arrayBuffer",data:str2utf8(t).buffer});var r,i,o,s=0,a=n.length,c=new ArrayBuffer(4*(a+2)),u=new Int32Array(c);for(u[0]=2037279074,u[1]=a,i=0;i<a;i++){if("arrayBuffer"===(r=n[i]).type)o=r.data.byteLength,n[i]=r.data;else{if("typeArray"!==r.type)throw"Polling emit not support binary type["+r.type+"]";o=(r=r.data.buffer).byteLength,n[i]=r}s+=o,u[i+2]=o}s+=c.byteLength,n.unshift(c);var l=new Uint8Array(s);for(a=n.length,i=o=0;i<a;i++)l.set(new Uint8Array(n[i]),o),o+=n[i].byteLength;t=l.buffer}else t="push"+t;return this.post(t)},Request.prototype.close=function(e,t){t=t||"";var n=arguments.length?JSON.stringify({code:e,reason:t}):"";this.post("clos"+n),this.disconnect(e,t)},Request.prototype.disconnect=function(e,t){this._connected&&(this._connected=!1,this._ws._close(e,t))};var _pollingRequest=null;function ___openRequest(){_pollingRequest||(_pollingRequest=new Request(this)),(this.socket=_pollingRequest).connect()}function OpenWebSocket(){var t=this,e=OpenWebSocket.client(t.url);t._useBlob&&(e.binaryType="blob"),e.onopen=function(){t._open(),e.send("9"+JSON.stringify([t._customHeaders]))},e.onmessage=function(e){t._transport.receiveData(e.data)},e.onerror=function(){t._error("WebSocket error")},e.onclose=function(e){t._close(e.code,e.reason)},t.socket=e}function isNumeric(e){return!isNaN(e-parseFloat(e))}function isFunction(e){return e&&"[object Function]"==={}.toString.call(e)}function isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}function isArray(e){return Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)}function isBlob(e){return null!==e&&"object"==typeof e&&"undefined"!=typeof Blob&&e.constructor===Blob}function isArrayBuffer(e){return null!==e&&"object"==typeof e&&"undefined"!=typeof ArrayBuffer&&e.constructor===ArrayBuffer}function isTypedArray(e){return null!==e&&"object"==typeof e&&"buffer"in e&&isArrayBuffer(e.buffer)}function flattenArray(e){return e.reduce(function(e,t){return e.concat(isArray(t)?flattenArray(t):t)},[])}function jsonDecode(e){try{return JSON.parse(e)}catch(e){return!1}}function receiveMessage(e,t){var n=this;if(t||"string"!=typeof e)resolveBuffer.call(n,e,!0);else if("1"!==(e+=""))if("2"!==e){var r=e.indexOf("[");if(-1!==r){var i=e.substr(0,r);e=jsonDecode(e.substr(r)),"0"!==i?e&&isArray(e)&&e.length&&(-1===i.indexOf("-")?triggerReceive.call(n,i,e):(i=i.split("-"),resolveBuffer.call(n,[parseInt(i[1]),i[0],e]))):initConnection.call(n,e)}}else clearPing.call(n)}function initConnection(e){var t=isArray(e)&&0<e.length&&isNumeric(e[0])?Math.round(e[0]):3e4;this._inited=!0,triggerEventCache.call(this),sendPreMessages.call(this),this._ws.polling||initPing.call(this,t)}function initPing(e){var t=this;t._interval=setInterval(function(){transferMessage.call(t,"1",null)},e)}function clearPing(){this._interval&&(clearInterval(this._interval),this._interval=null)}function resolveBuffer(e,t){var n=this;t?n._dataMessage.length&&(n._bufferMessage.push(e),n._bufferMessage.length===n._dataMessage[0][0]&&(parseBufferMessage.call(this,n._dataMessage.shift(),n._bufferMessage.slice()),n._bufferMessage=[])):n._dataMessage.push(e)}function parseBufferMessage(e,t){e[2]=decodeBufferMessage(e[2],t),triggerReceive.call(this,e[1],e[2])}function decodeBufferMessage(e,n){if(isArray(e)){var r=[];return e.forEach(function(e,t){r[t]=decodeBufferMessage(e,n)}),r}if(isObject(e)){if("_bin_"in e&&"_num_"in e&&isNumeric(e._num_))return n[e._num_];for(var t in e)e.hasOwnProperty(t)&&(e[t]=decodeBufferMessage(e[t],n));return e}return e}function triggerReceive(e,t){var n=e.charAt(0);if("3"===n){var r=t.shift();this.has(r)&&triggerBindEvent.call(this,e,r,t)}else"4"===n&&triggerReplyEvent.call(this,e,t)}function triggerReplyEvent(e,t){if(!(e.length<2)){var n=e.substr(1);"s"+n in this._callbacks&&this._callbacks["s"+n].apply(this._ws,t)}}function triggerBindEvent(e,t,n){this._inited?triggerEventNow.call(this,e,t,n):this._aheadMessage.push([e,t,n])}function triggerEventCache(){var t=this;t._aheadMessage.forEach(function(e){triggerEventNow.call(t,e[0],e[1],e[2])})}function triggerEventNow(e,t,n){var r=this;if(1<e.length){var i=e.substr(1);r._replies["r"+i]=1,n.push(function(){var e=[].slice.call(arguments);e.push(i),replyMessage.call(r,e)})}r.get(t).forEach(function(e){e.callback.apply(r._ws,n)})}function replyMessage(e){var t=e.pop();"r"+t in this._replies&&(delete this._replies["r"+t],sendMessage.call(this,e,t))}function sendPreMessages(){var t=this;t._presendMessage.forEach(function(e){sendMessage.call(t,e[0],e[1])})}function sendMessage(e,t){if(this._inited){var n;if(!1===t){n="3";var r=e.pop();isFunction(r)?n+=""+getCallbackCode.call(this,r):e.push(r)}else n="4"+t;var i=[];e=encodeBufferMessage(e,i),transferMessage.call(this,n,e,i)}else this._presendMessage.push([e,t])}function getCallbackCode(e){var t=null;for(var n in this._callbacks)t=n;return t=null===t?0:parseInt(t.substr(1))+1,this._callbacks["s"+t]=e,t}function transferMessage(e,t,n){if(this._inited){var r=this._ws;if(r.polling)r.socket.send(e,t,n);else if(null===t)r.socket.send(e);else{var i=n.length;r.socket.send(e+""+(i?"-"+i:"")+JSON.stringify(t)),i&&n.forEach(function(e){r.socket.send(e.data)})}}}function encodeBufferMessage(e,n){if(isArray(e)){var r=[];return e.forEach(function(e,t){r[t]=encodeBufferMessage(e,n)}),r}if(isBlob(e))return appendBuffer(e,"blob",n);if(isArrayBuffer(e))return appendBuffer(e,"arrayBuffer",n);if(isTypedArray(e))return appendBuffer(e,"typeArray",n);if(isObject(e)){if("_bin_"in e&&"_num_"in e&&isNumeric(e._num_))return n[e._num_];for(var t in e)e.hasOwnProperty(t)&&(e[t]=encodeBufferMessage(e[t],n));return e}return e}function appendBuffer(e,t,n){return n.push({type:t,data:e}),{_bin_:1,_num_:n.length-1}}function parseEvent(e){var t="",n=e.lastIndexOf(".");return-1<n&&(t=e.slice(0,n),e=e.substr(n+1)),[t,e]}function Transport(e){this._ws=e,this._inited=!1,this._interval=null,this._listeners={},this._replies={},this._callbacks={},this._dataMessage=[],this._bufferMessage=[],this._presendMessage=[],this._aheadMessage=[]}function Ws(e){var t=!!OpenWebSocket&&OpenWebSocket.client();this.url=e,this.socket=null,this.polling=t<1,this.wechat=1<t,this._useBlob=!1,this._attempt=0,this._reconnectTimes=-1,this._reconnectDelayMin=1e3,this._reconnectDelayRand=2e3,this._customHeaders={},this._openfn=null,this._errorfn=null,this._closefn=null,this._resolveBase64=null,this._transport=new Transport(this)}function getOptionNumber(e){if(!isNumeric(e))throw new Error("arguments must be number");return Math.floor(e)}function getFunction(e){if(!isFunction(e))throw new Error("callback must be function");return e}function openWs(){try{if(this.polling){if(void 0===___openRequest||!isFunction(___openRequest))throw"Client not support WebSocket";___openRequest.call(this)}else OpenWebSocket.call(this)}catch(e){if(!this._errorfn)throw new Error(e);this._errorfn(e)}}return OpenWebSocket.client=function(e){var t=void 0===e,n="object"==typeof window?"WebSocket"in window?window.WebSocket:"MozWebSocket"in window?window.MozWebSocket:null:null;if(!n){if(t)return 0;throw"Client not support webSocket"}if(t)return 1;if(n=new n(e),!n)throw"Create window webSocket failed";return n},Transport.prototype={on:function(e,t){var n=(e=parseEvent(e))[0];return(e=e[1])in this._listeners||(this._listeners[e]=[]),this._listeners[e].push({prefix:n,callback:t}),this},off:function(e){var t=(e=parseEvent(e))[0];if(!((e=e[1])in this._listeners))return this;if(""===t)return delete this._listeners[e],this;for(var n=this._listeners[e],r=n.length;r--;)n[r].prefix===t&&n.splice(r,1);return this},has:function(e){return e in this._listeners},get:function(e){return this.has(e)?this._listeners[e]:[]},receiveData:function(e,t){receiveMessage.call(this,e,t)},sendData:function(e){sendMessage.call(this,e,!1)},reset:function(){this._inited=!1,this._replies={},this._callbacks={},this._dataMessage=[],this._bufferMessage=[],this._presendMessage=[],this._aheadMessage=[],clearPing.call(this)}},Ws.prototype={_open:function(){this._openfn&&this._openfn.call(this,this._attempt),this._attempt=0},_error:function(e){this._errorfn&&this._errorfn(this._attempt,e),0===this._reconnectTimes||0<this._reconnectTimes&&this._attempt>=this._reconnectTimes||setTimeout(this.open.bind(this),this._reconnectDelayMin+parseInt(Math.random()*(this._reconnectDelayRand+1),10))},_close:function(e,t){this._transport.reset(),this._closefn&&this._closefn(e,t)},reconnectTimes:function(e){return this._reconnectTimes=getOptionNumber(e),this},reconnectDelay:function(e,t){return this._reconnectDelayMin=getOptionNumber(e),this._reconnectDelayRand=Math.max(getOptionNumber(t)-this._reconnectDelayMin,800),this},useBlob:function(e){return this._useBlob=!!e,this.socket&&(this.socket.binaryType=e?"blob":"arraybuffer"),this},resolveBase64:function(e){return this._resolveBase64=getFunction(e),this},headers:function(e){return isObject(e)&&(this._customHeaders=e),this},onOpen:function(e){return this._openfn=getFunction(e),this},onError:function(e){return this._errorfn=getFunction(e),this},onClose:function(e){return this._closefn=getFunction(e),this},on:function(e,t){return this._transport.on(e,getFunction(t)),this},off:function(){var t=this;return flattenArray([].slice.call(arguments)).forEach(function(e){t._transport.off(e)}),t},open:function(){return this._attempt++,openWs.call(this),this},emit:function(e,t){return this._transport.sendData([].slice.call(arguments)),this},close:function(e,t){return((e=!!isNumeric(e)&&parseInt(e))<3e3&&1e3!==e||4999<e)&&(e=!1),e?this.socket.close(e,t?t+"":""):this.socket.close(),this}},Ws});